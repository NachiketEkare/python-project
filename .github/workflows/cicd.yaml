name: ECS CI/CD Pipeline

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPO: 650080740886.dkr.ecr.us-east-1.amazonaws.com/predict-api
  ECS_CLUSTER: predict-service-cluster
  ECS_SERVICE: predict-service-service
  CONTAINER_NAME: fastapi
  TASK_DEFINITION_FAMILY: predict-service-task
  AWS_ACCOUNT_ID: 650080740886

jobs:
  ci:
    name: Build & Push Image to ECR
    runs-on: ubuntu-latest

    outputs:
      image_uri: ${{ steps.build_image.outputs.image_uri }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubDeployRole
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build & Push Image
      id: build_image
      run: |
        IMAGE_TAG=${{ github.sha }}
        IMAGE_URI="$ECR_REPO:$IMAGE_TAG"

        echo "Building image $IMAGE_URI"
        docker build -t $IMAGE_URI .

        echo "Pushing image $IMAGE_URI"
        docker push $IMAGE_URI

        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

  cd:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: ci

    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubDeployRole
        aws-region: ${{ env.AWS_REGION }}

    - name: Debug â€“ List files in repo
      run: |
        echo "Current directory:"
        pwd
        echo "Listing tree:"
        ls -R .

    - name: Render New Task Definition
      run: |
        IMAGE_URI="${{ needs.ci.outputs.image_uri }}"
        sed "s|REPLACE_IMAGE|$IMAGE_URI|g" python-project/.github/taskdef.json > new-task-def.json

    - name: Register New Task Definition
      id: register
      run: |
        OUTPUT=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json)
        echo "$OUTPUT"
        ARN=$(echo "$OUTPUT" | jq -r '.taskDefinition.taskDefinitionArn')
        echo "taskdef_arn=$ARN" >> $GITHUB_OUTPUT

    - name: Update ECS Service
      run: |
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --task-definition ${{ steps.register.outputs.taskdef_arn }}

    - name: Wait for Deployment
      run: |
        aws ecs wait services-stable \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE

    - name: Done
      run: echo "Deployment Successful!"
